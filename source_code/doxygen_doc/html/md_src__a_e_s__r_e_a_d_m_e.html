<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Mooltipass: Mooltipass AES description</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="HaD_Mooltipass.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Mooltipass
   </div>
   <div id="projectbrief">Offline Password Keeper Developed on Hackaday</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Mooltipass AES description </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>1- AVR CRYPTOLIB </h2>
<p>Mooltipass encryption is achieved by AVR Cryptolib. We can get the libraries and a description of the different files from the author website: <a href="http://avrcryptolib.das-labor.org/trac/wiki/AES">AES libraries and description</a>. We are only using the necessary files to get AES256 encryption and decryption working, the other files are removed. As you may notice, we are using the ASM implementation of the library because it's lighter in code size and faster in execution.</p>
<p>How to use the library? how to work with it ? As easy as it sounds, you only have to care about 3 functions: aes256_init, aes256_encrypt and aes256_decrypt. Here it is a simple example:</p>
<p>``` void aes256_test(void) { // aes256 is 32 byte key uint8_t key[32] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 21,22,23,24,25,26,27,28,29,30,31};</p>
<p>// aes256 is 16 byte data size uint8_t data[16] = "text to encrypt";</p>
<p>// declare the context where the round keys are stored <a class="el" href="structaes256__ctx__t.html">aes256_ctx_t</a> ctx;</p>
<p>// Initialize the AES256 with the desired key aes256_init(key, &amp;ctx);</p>
<p>// Encrypt data // "text to encrypt" (ascii) -&gt; '9798D10A63E4E167122C4C07AF49C3A9'(hexa) aes256_enc(data, &amp;ctx);</p>
<p>// Decrypt data // '9798D10A63E4E167122C4C07AF49C3A9'(hexa) -&gt; "text to encrypt" (ascii) aes256_dec(data, &amp;ctx); } ```</p>
<h2>2- Testing avr-cryptolib using nessie test vectors </h2>
<p>After downloading a third party library or resource you must ensure the library performs the function as well as it is claimed. So to satisfy our paranoia against any bug or error with the library, we have checked the encyrption and decryption using different test vectors, called Nessie Test Vectors. There are 8 different sets of test vectors, we have checked AES256 against all.</p>
<p>To test AES256 using nessie vectors, we have created a file called <a class="el" href="aes256__nessie__test_8c.html" title="Different functions to check AES256 using nessie test vectors.   see https://www.cosic.esat.kuleuven.be/nessie/testvectors/   Block Cipher -> Rijndael -> key size 256.   To verify the output of tests, do a log with output and see differences with a diff viewer.  . ">aes256_nessie_test.c</a>. This file outputs the results of nessie test into UART, USB CDC or whatever function you want. You only have to initialize the function pointer to print the output where you want.</p>
<p>Sample code to print the output through USB CDC:</p>
<p>``` #include "aes256_nessie_test.h"</p>
<p>void <a class="el" href="mooltipass_8c.html#a568b3afc214ba30be5bf526d6b27b611" title="Main function. ">main(void)</a> { /* INITIALIZATION OF USB CDC */</p>
<p>// Redirect nessieOutput to usb_serial_putchar nessieOutput = </p>
<p>// Test all sets of nessie vectors nessieTest(1); nessieTest(2); nessieTest(3); nessieTest(4); nessieTest(5); nessieTest(6); nessieTest(7); nessieTest(8); } ```</p>
<p>Nessie test vectors and output are located in <a href="https://www.cosic.esat.kuleuven.be/nessie/testvectors">https://www.cosic.esat.kuleuven.be/nessie/testvectors</a> Block Cipher -&gt; Rijndael -&gt; key size 256.</p>
<p>The output of all nessieTest functions are formatted in the same way as the file <b>aes256_nessie_test.txt</b>, so... you must save the output (using cutecom or similar hyperterminal program) into a file and check the differences between your file and <b>aes256_nessie_test.txt</b> using a diff viewer.</p>
<h2>3- CTR block encryption </h2>
<p>The passwords stored on the mooltipass will be encrypted using CTR block encryption, more information in: <a href="http://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Counter_.28CTR.29">Counter CTR </a>. We must decide how to generate the initialization vector. Here's an example of use of CTR encryption and decryption.</p>
<p>``` static uint8_t key[32] = { 0x60, 0x3d, 0xeb, 0x10, 0x15, 0xca, 0x71, 0xbe, 0x2b, 0x73, 0xae, 0xf0, 0x85, 0x7d, 0x77, 0x81, 0x1f, 0x35, 0x2c, 0x07, 0x3b, 0x61, 0x08, 0xd7, 0x2d, 0x98, 0x10, 0xa3, 0x09, 0x14, 0xdf, 0xf4 };</p>
<p>static uint8_t iv[16] = { 0xf0, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8, 0xf9, 0xfa, 0xfb, 0xfc, 0xfd, 0xfe, 0xff };</p>
<p>char text[32] = "this is my pass to encrypt";</p>
<p>void <a class="el" href="mooltipass_8c.html#a568b3afc214ba30be5bf526d6b27b611" title="Main function. ">main(void)</a> { /* Stuff here */</p>
<p>// Declare aes256 context variable <a class="el" href="structaes256_ctr_ctx__t.html">aes256CtrCtx_t</a> ctx;</p>
<p>// Save key and initialization vector inside context aes256CtrInit(&amp;ctx, key, iv, 16);</p>
<p>aes256CtrEncrypt(&amp;ctx, key, text, sizeof(text)); // here array pass has been encrypted</p>
<p>/* Before decrypt is necessary to initialize the context another time due to ctx-&gt;ctr value is being modified during encrypt (it's value is being incremented on each block encrypt operation) */</p>
<p>// Save key and initialization vector inside context aes256CtrInit(&amp;ctx, key, iv, 16);</p>
<p>aes256CtrDecrypt(&amp;ctx, key, text, sizeof(text)); // decrypting make text to be "this is my pass to encrypt" again. } ``` Data input in aes256CtrEncrypt and aes256CtrDecrypt must be multiple of 16 bytes length.</p>
<p>As said, we like to test our code and verify it has no bugs so... you can test CTR encryption implementation by using <b><a class="el" href="aes256__ctr__test_8c.html" title="Different functions to check AES256CTR encryption. ">aes256_ctr_test.c</a></b> functions and doing a diff against <b>aes256_ctr_test.txt</b>. CTR vectors used in aes256CtrTest are from <a href="http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf">http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf</a>. ``` void <a class="el" href="mooltipass_8c.html#a568b3afc214ba30be5bf526d6b27b611" title="Main function. ">main(void)</a> { </p><pre class="fragment">/*
    INITIALIZATION OF USB CDC
*/

// Redirect ctrTestOutput to usb_serial_putchar function
ctrTestOutput = &amp;usb_serial_putchar;

aes256CtrTest();
</pre><p> } ```</p>
<h2>4- Description of files </h2>
<ul>
<li>AVR-cryptolib files used in this project:</li>
</ul>
<p>``` aes/aes_dec-asm.S -&gt; aes decrypt file aes/aes_enc-asm.S -&gt; aes encrypt file aes/aes_keyschedule-asm.S -&gt; aes key schedule, see <a href="http://en.wikipedia.org/wiki/Rijndael_key_schedule">http://en.wikipedia.org/wiki/Rijndael_key_schedule</a> aes/aes_sbox-asm.S -&gt; aes substitution box, see <a href="http://en.wikipedia.org/wiki/Rijndael_S-box">http://en.wikipedia.org/wiki/Rijndael_S-box</a> aes/aes_invsbox-asm.S -&gt; aes inverse substitution box, see <a href="http://en.wikipedia.org/wiki/Rijndael_S-box">http://en.wikipedia.org/wiki/Rijndael_S-box</a> gf256mul/gf256mul.S -&gt; Galois Field multiplication, see <a href="http://www.samiam.org/galois.html">http://www.samiam.org/galois.html</a> avr-asm-macros.S -&gt; specific macros to work with the library ```</p>
<ul>
<li>Custom files done by mooltipass team:</li>
</ul>
<p>``` <a class="el" href="aes256__nessie__test_8c.html" title="Different functions to check AES256 using nessie test vectors.   see https://www.cosic.esat.kuleuven.be/nessie/testvectors/   Block Cipher -> Rijndael -> key size 256.   To verify the output of tests, do a log with output and see differences with a diff viewer.  . ">aes256_nessie_test.c</a> (only used for test) <a class="el" href="aes256__ctr__test_8c.html" title="Different functions to check AES256CTR encryption. ">aes256_ctr_test.c</a> (only used for test) <a class="el" href="aes256__ctr_8c.html" title="AES256CTR encryption. ">aes256_ctr.c</a> ```</p>
<ul>
<li>Files to check aes256_enc/dec and aes256_ctr tests:</li>
</ul>
<p>``` aes256_nessie_test.txt aes256_ctr_test.txt ``` </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Apr 21 2014 22:26:16 for Mooltipass by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
